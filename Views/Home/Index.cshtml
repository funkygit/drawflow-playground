@{
    ViewData["Title"] = "Workflow Editor";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
<style>
    #drawflow {
        width: 100%;
        height: 700px;
        border: 1px solid #ccc;
        position: relative;
    }

    /* Node status badges */
    .node-status {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background-color: gray;
        border: 1px solid white;
    }
    .status-running { background-color: yellow; }
    .status-completed { background-color: green; }
    .status-failed { background-color: red; }

    /* Drawflow node overrides for wider config content */
    .drawflow-node {
        min-width: 260px;
        max-width: 380px;
    }
    .drawflow-node .drawflow_content_node {
        padding: 0;
        width: auto;
    }

    /* In-node config container */
    .node-config-container {
        font-size: 0.75rem;
        padding: 6px 8px;
        min-width: 240px;
    }

    /* Title row */
    .node-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 6px;
        background: #4a90d9;
        color: #fff;
        border-radius: 3px 3px 0 0;
        margin: -6px -8px 6px -8px;
        font-weight: 600;
        font-size: 0.8rem;
    }
    .node-title .node-id-badge {
        font-size: 0.65rem;
        opacity: 0.8;
        font-weight: 400;
    }

    /* Variant selector */
    .node-variant-row {
        margin-bottom: 6px;
    }
    .node-variant-row label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 2px;
        display: block;
    }
    .node-variant-row select {
        font-size: 0.72rem;
        padding: 2px 4px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 3px;
    }

    /* Parameter table */
    .node-params-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 6px;
    }
    .node-params-table td {
        padding: 2px 4px;
        vertical-align: middle;
        border-bottom: 1px solid #eee;
    }
    .node-params-table td:first-child {
        font-weight: 600;
        color: #555;
        white-space: nowrap;
        width: 40%;
        font-size: 0.68rem;
    }
    .node-params-table input,
    .node-params-table select {
        font-size: 0.72rem;
        padding: 2px 4px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 3px;
        box-sizing: border-box;
    }
    .node-params-table input[readonly] {
        background: #f0f0f0;
        color: #888;
    }

    /* Variant-based row visibility */
    .node-param-row.variant-hidden,
    .node-param-row.condition-hidden {
        display: none;
    }

    /* Previous connected nodes display */
    .node-prev-nodes {
        margin-top: 6px;
        padding-top: 4px;
        border-top: 1px solid #ddd;
    }
    .node-prev-nodes-label {
        font-size: 0.65rem;
        font-weight: 600;
        color: #777;
        margin-bottom: 3px;
    }
    .node-prev-badge {
        display: inline-block;
        font-size: 0.65rem;
        background: #e8f0fe;
        color: #1a73e8;
        padding: 1px 6px;
        border-radius: 10px;
        margin: 1px 2px;
        border: 1px solid #c5d9f5;
    }
    .node-prev-nodes-empty {
        font-size: 0.65rem;
        color: #aaa;
        font-style: italic;
    }

    /* Update button inside node */
    .node-update-btn {
        margin-top: 4px;
        font-size: 0.68rem;
        padding: 2px 8px;
        width: 100%;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    .node-update-btn:hover {
        background: #5a6268;
    }

    /* Output port labels (True/False, CurrentItem/Exit, etc.) */
    .output .port-label {
        position: absolute;
        right: 18px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.6rem;
        font-weight: 600;
        color: #555;
        background: #e8f0fe;
        padding: 1px 5px;
        border-radius: 3px;
        white-space: nowrap;
        pointer-events: none;
        line-height: 1.3;
    }

    /* Right-click context menu */
    .node-context-menu {
        position: fixed;
        z-index: 10000;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.18);
        min-width: 140px;
        padding: 4px 0;
        font-size: 0.85rem;
    }
    .ctx-item {
        padding: 6px 14px;
        cursor: pointer;
        white-space: nowrap;
    }
    .ctx-item:hover {
        background: #e8f0fe;
    }

    /* Test modal */
    .test-modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.45);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .test-modal {
        background: #fff;
        border-radius: 8px;
        min-width: 420px;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    }
    .test-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: #4a90d9;
        color: #fff;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
    }
    .test-modal-header button {
        background: none; border: none; color: #fff;
        font-size: 1.1rem; cursor: pointer; opacity: 0.8;
    }
    .test-modal-header button:hover { opacity: 1; }
    #test-modal-body {
        padding: 16px;
        overflow-y: auto;
        flex: 1;
    }
    #test-modal-body table {
        width: 100%;
        border-collapse: collapse;
    }
    #test-modal-body td {
        padding: 5px 6px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
        font-size: 0.82rem;
    }
    #test-modal-body td:first-child {
        font-weight: 600;
        color: #555;
        width: 40%;
        white-space: nowrap;
    }
    #test-modal-body input, #test-modal-body select {
        width: 100%;
        padding: 4px 6px;
        font-size: 0.82rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    #test-modal-body input[readonly] {
        background: #f0f0f0;
        color: #888;
    }
    .test-modal-footer {
        padding: 10px 16px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        align-items: center;
    }
    #test-modal-status {
        flex: 1;
        font-size: 0.8rem;
        color: #888;
    }
    .test-result-box {
        margin-top: 12px;
        padding: 10px;
        border-radius: 6px;
        font-size: 0.82rem;
        white-space: pre-wrap;
        word-break: break-all;
    }
    .test-result-success { background: #e8f5e9; border: 1px solid #a5d6a7; color: #2e7d32; }
    .test-result-error   { background: #fce4ec; border: 1px solid #ef9a9a; color: #c62828; }
    .param-source-badge {
        font-size: 0.65rem;
        padding: 1px 5px;
        border-radius: 3px;
        font-weight: 400;
        margin-left: 4px;
    }
    .badge-node-output { background: #fff3e0; color: #e65100; }
    .badge-user-input  { background: #e3f2fd; color: #1565c0; }
    .badge-constant    { background: #f3e5f5; color: #7b1fa2; }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-9">
            <div id="drawflow"></div>
        </div>
        <div class="col-md-3">
            <h4>Available Nodes</h4>
            <div id="available-nodes" class="list-group" style="max-height: 300px; overflow-y: auto;">
                <!-- Dynamically populated -->
            </div>
            <hr />
            <h4>Legacy Nodes</h4>
            <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="start">
                <i class="fas fa-play"></i><span> Start</span>
            </div>
            <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="end">
                <i class="fas fa-stop"></i><span> End</span>
            </div>
            <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="loop">
                <i class="fas fa-sync"></i><span> Loop</span>
            </div>
            <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="conditional">
                <i class="fas fa-question-circle"></i><span> Conditional</span>
            </div>
            <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="iterator">
                <i class="fas fa-list-ol"></i><span> Iterator</span>
            </div>

            <hr />
            <h3>Controls</h3>
            <div class="mb-2">
                <input type="text" id="workflow-name" class="form-control form-control-sm"
                       placeholder="Workflow name..." />
            </div>
            <button class="btn btn-primary w-100 mb-2" onclick="saveWorkflow()">Save Workflow</button>
            <button class="btn btn-outline-secondary w-100 mb-2" onclick="showLoadDialog()">Load Workflow</button>
            <button class="btn btn-success w-100 mb-2" onclick="runWorkflow()">Run Workflow</button>

            <hr />
            <h4>Log</h4>
            <div id="log" style="height: 200px; overflow-y: scroll; border: 1px solid #eee; font-size: 0.8em;"></div>
        </div>
    </div>
</div>

<!-- Right-click context menu -->
<div id="node-context-menu" class="node-context-menu" style="display:none;">
    <div class="ctx-item" onclick="testSelectedNode()">🧪 Test Node</div>
</div>

<!-- Test popup modal -->
<div id="test-modal-overlay" class="test-modal-overlay" style="display:none;">
    <div class="test-modal">
        <div class="test-modal-header">
            <span id="test-modal-title">Test Node</span>
            <button onclick="closeTestModal()">✕</button>
        </div>
        <div id="test-modal-body"></div>
        <div class="test-modal-footer">
            <span id="test-modal-status"></span>
            <button class="btn btn-primary btn-sm" id="test-run-btn" onclick="executeNodeTest()">Run Test</button>
            <button class="btn btn-secondary btn-sm" onclick="closeTestModal()">Cancel</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script src="/js/dynamic-form-renderer.js"></script>
<script src="/js/workflow-utils.js"></script>
<script src="/js/workflow-manager.js"></script>
<script src="/js/index-controller.js"></script>
